
# ポートフォリオ・オートリバランス戦略 ［Auto Rebalancing Portfolio］

---

## 概要：複数の銘柄を含むポートフォリオを作成し、定期的にLotの調整を行い利益を伸ばす戦略

* ポートフォリオ全体のUSDバリュー（PV)が一定の割合で増加した際に、基準の値幅以上の動きを伴い利益を出している銘柄を部分利確する
* 仮に大きき利益を伸ばしている特定の銘柄があっても、利確を開始する基準の目標のポートフォリオバリュー（TPV）に達していない場合は、その利益をポートフォリオ全体の価値の保持につとめ、利確は行わない。
* 日次（東京市場スタートに合わせ）で、TPV調整、各シンボルの利確の目安となるATR%の調整を行う（daily_initialize)。TPV、ATR％はリアルタイムで変更せず、1日の間は日次の基準を対象を常時参考とする。
* 利確を行い、少なくなった銘柄のLotはdaily_initializeの際に調整する
* PVが増加せず、長期間TPVに達しなくてもLotの追加（いわゆるナンピン）は行わない
* リバランスの有無の確認は基本30分に1回とする。
* リバランス確認の際は有効証拠金の20％を超える含み損がないか確認し、この条件となっている場合は、サーキットブレーカーとしてすべてのポジションをクローズする。



ポートフォリオ・バリュー（PV）を決定
TPV＝対象のポートフォリオに含まれる各銘柄のコントラクトサイズ、Lot数からUSD建てで計算する値し合計したもの
有効証拠金（USD建て）の5倍を基本とする（有効証拠金3000USDの場合：15000USD程度）

ターゲット・ポートフォリオ・バリュー（TPV）を決定
TPの1.3倍を基本とする

---

## イニシャルポートフォリオの作成

### ポートフォリオ銘柄の選定

選定銘柄（以後シンボルと表記）のエントリー方向、Lot数の決定

対象となる銘柄の候補は以下（今後変更の可能性有り）
```
XAUUSD
USOIL
DXY
US500
US30
USTEC
STOXX50
DE30
FR40
UK100
HK50
AUS200
```


エントリー方向はすべてLong
ポジション全体のPVが設定した値になるように、Lot数は以下のロジックで決定
各シンボルの相関係数をもとにウエイトを決定
ATR％をもとにLot数の調整、決定


## リバランスの方法

リバランスには、以下の2種類がある
1. リアルタイムリバランス
2. デイリーリバランス

### 1.リアルタイムリバランス

リアルタイムリバランスは基本的に30分に1度、リバランスが必要かどうか以下の内容を確認する

#### 確認内容

実行時に対象となるPVが、TPVを超えているか？　→超えていない場合、その後の実装はパス

TPVを超えている場合、保有シンボルの中で利確の条件となる変化率（対象のATR%）に達しているか調査
達している場合は、利確として部分利確分のLot分反対方向のポジションを持つ（ヘッジ）

#### 部分利確のルール

* その日の対象のATR％の60％を超えた際に、1段階目の利確として全Lot数の内の5割を利確（ヘッジ）し、利確時の価格をDBへ永続化する
* その日の対象のATR%の100％を超えた際に、2段階目の利確として全Lot数の内の3割を利確（ヘッジ）し、利確時の価格をDBへ永続化する
* その日の対象のATR%の150％を超えた際に、3段階目の利確として全Lot数の内の2割を利確（ヘッジ）し、利確時の価格をDBへ永続化する

#### 部分Lot追加のルール

* 1段階目の利確済みで、利確した際の価格に対しデイリー変化率がATR%の60％以上マイナスとなり、価格を戻した時対象シンボルの対象Lotの5割をLong方向でエントリーする。
* 2段階目の利確済みで、利確した際の価格に対しデイリー変化率がATR%の100％以上マイナスとなり、価格を戻した時対象シンボルの対象Lotの3割をLong方向でエントリーする。
* 3段階目の利確済みで、利確した際の価格に対しデイリー変化率がATR%の150％以上マイナスとなり、価格を戻した時対象シンボルの対象Lotの2割をLong方向でエントリーする。

#### サーキットブレーカの確認（実施）

デイリーPVの半分を割った際に発動し、その際のポジションを全てクローズし、その日中の新規取引を中止する（global_runningをOFF）

---

### 2.デイリーリバランス

デイリーリバランスは、デイリー・イニシャライズ実行時に行います。
新しい日のPVを基に、イニシャルポートフォリオの作成の計算方法と同様にLotを計算し、現在のポジションのLot数と比べ差分の分を新たに追加Lotとしてエントリーします。

---

## デイリー・イニシャライズの実装
月、火、水、木、金の毎日1回、9:00に実行し以下の処理を行う

* システム全体のglobal_runningをONにする
* デイリーエクイティと取得し、DBへ保存
* デイリーエクイティに合わせ、デイリーPV,デイリーTPVを調整し、DBへ保存
* デイリーリバランスの実施（利確済みシンボルのLot調整、新たなデイリーPVに合わせ必要なシンボルのLot調整を行う）
* 対象シンボルの価格を取得、DBへ保存（その日の日時変化率の計算に利用する）
* 対象シンボルのATR％（4時間足、14本）を取得し、DBへ保存
* Slackへ通知

---

## デイリー・デイニシャライズの実装

火、水、木、金、土の毎日1回、6:55に実行し以下の処理を行う
* システム全体のglobal_runningをOFF
* Slackへ通知